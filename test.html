<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reddit Dashboard - Fixed Version</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f6f6f6;
        color: #1c1c1c;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: #ff4500;
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 30px;
      }

      .lanes-container {
        min-height: 400px;
      }

      .lane {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .add-lane {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 20px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
      }

      input:focus {
        border-color: #ff4500;
        outline: none;
      }

      button {
        background: #ff4500;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
      }

      button:hover {
        background: #e03d00;
      }

      .post {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
      }

      .post:last-child {
        border-bottom: none;
      }

      .post-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: #1c1c1c;
        text-decoration: none;
        display: block;
      }

      .post-title:hover {
        color: #ff4500;
      }

      .post-meta {
        color: #787c7e;
        font-size: 14px;
      }

      .error {
        color: #ff4500;
        background: #fff5f5;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }

      .success {
        color: #46d160;
        background: #f8fff9;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸš€ Reddit Dashboard</h1>
        <p>Monitor multiple subreddits in one place</p>
      </div>

      <div class="dashboard">
        <div class="lanes-container" id="lanesContainer">
          <div class="lane">
            <h3>No subreddits added yet</h3>
            <p>Add your first subreddit to get started!</p>
          </div>
        </div>

        <div class="add-lane">
          <h3>Add Subreddit</h3>
          <div class="form-group">
            <input
              type="text"
              id="subredditInput"
              placeholder="r/programming"
              value="programming"
            />
          </div>
          <button onclick="addSubreddit()">Add Subreddit</button>
          <div id="message"></div>

          <div style="margin-top: 20px; font-size: 14px; color: #666">
            <p><strong>Try these:</strong></p>
            <p
              style="margin: 5px 0; cursor: pointer; color: #ff4500"
              onclick="quickAdd('javascript')"
            >
              r/javascript
            </p>
            <p
              style="margin: 5px 0; cursor: pointer; color: #ff4500"
              onclick="quickAdd('reactjs')"
            >
              r/reactjs
            </p>
            <p
              style="margin: 5px 0; cursor: pointer; color: #ff4500"
              onclick="quickAdd('webdev')"
            >
              r/webdev
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      class RedditService {
        constructor() {
          this.subreddits = new Set();
        }

        async fetchSubredditPosts(subreddit) {
          try {
            // Ø±ÙˆØ´ Û±: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² no-cors Ùˆ Ø³Ù¾Ø³ parse Ú©Ø±Ø¯Ù† response
            const response = await this.fetchWithFallback(subreddit);

            if (!response.data || !response.data.children) {
              throw new Error("Invalid response format");
            }

            return response.data.children.slice(0, 10).map((post) => ({
              id: post.data.id,
              title: post.data.title,
              author: post.data.author,
              score: post.data.score,
              comments: post.data.num_comments,
              url: `https://reddit.com${post.data.permalink}`,
              created: new Date(
                post.data.created_utc * 1000
              ).toLocaleDateString(),
            }));
          } catch (error) {
            console.error(`Error fetching r/${subreddit}:`, error);
            throw new Error(`Failed to load r/${subreddit}: ${error.message}`);
          }
        }

        async fetchWithFallback(subreddit) {
          // Ù„ÛŒØ³Øª Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
          const endpoints = [
            // Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ… (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ CORS fail Ø´ÙˆØ¯)
            `https://www.reddit.com/r/${subreddit}.json?limit=10`,

            // Ù¾Ø±ÙˆÚ©Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            `https://corsproxy.io/?${encodeURIComponent(
              `https://www.reddit.com/r/${subreddit}.json?limit=10`
            )}`,
            `https://api.allorigins.win/raw?url=${encodeURIComponent(
              `https://www.reddit.com/r/${subreddit}.json?limit=10`
            )}`,

            // Ø±ÙˆØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² reddit.com Ø¨Ø¯ÙˆÙ† www
            `https://reddit.com/r/${subreddit}.json?limit=10`,

            // Ø±ÙˆØ´ JSONP Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡
            `https://www.reddit.com/r/${subreddit}/.json?limit=10&raw_json=1`,
          ];

          for (const endpoint of endpoints) {
            try {
              console.log(`Trying: ${endpoint}`);
              const response = await fetch(endpoint);

              if (response.ok) {
                const text = await response.text();

                // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒÙ… Ú©Ù‡ Ù¾Ø§Ø³Ø® JSON Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
                if (text.trim().startsWith("{")) {
                  return JSON.parse(text);
                } else {
                  // Ø§Ú¯Ø± HTML Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
                  continue;
                }
              }
            } catch (error) {
              console.warn(`Endpoint failed: ${endpoint}`, error);
              continue;
            }
          }

          throw new Error("All endpoints failed");
        }

        async validateSubreddit(subreddit) {
          try {
            await this.fetchSubredditPosts(subreddit);
            return true;
          } catch (error) {
            return false;
          }
        }

        addSubreddit(subreddit) {
          if (this.subreddits.has(subreddit)) {
            throw new Error(`r/${subreddit} is already added`);
          }
          this.subreddits.add(subreddit);
          return subreddit;
        }

        getSubreddits() {
          return Array.from(this.subreddits);
        }

        removeSubreddit(subreddit) {
          this.subreddits.delete(subreddit);
        }
      }

      // Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³
      const redditService = new RedditService();

      // ØªÙˆØ§Ø¨Ø¹ UI
      function showMessage(message, type = "error") {
        const messageDiv = document.getElementById("message");
        messageDiv.innerHTML = `<div class="${type}">${message}</div>`;
        setTimeout(() => {
          messageDiv.innerHTML = "";
        }, 5000);
      }

      async function addSubreddit() {
        const input = document.getElementById("subredditInput");
        const subreddit = input.value.trim().toLowerCase().replace("r/", "");

        if (!subreddit) {
          showMessage("Please enter a subreddit name");
          return;
        }

        showMessage("ğŸ”„ Checking subreddit...", "success");

        try {
          // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø³Ø§Ø¨Ø±Ø¯ÛŒØª
          const isValid = await redditService.validateSubreddit(subreddit);

          if (!isValid) {
            throw new Error(`r/${subreddit} not found or inaccessible`);
          }

          // Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø§Ø¨Ø±Ø¯ÛŒØª
          redditService.addSubreddit(subreddit);

          // Ø±ÙØ±Ø´ Ù†Ù…Ø§ÛŒØ´
          await refreshLanes();

          showMessage(`âœ… r/${subreddit} added successfully!`, "success");
          input.value = "";
        } catch (error) {
          showMessage(error.message);
        }
      }

      function quickAdd(subreddit) {
        document.getElementById("subredditInput").value = subreddit;
        addSubreddit();
      }

      async function refreshLanes() {
        const lanesContainer = document.getElementById("lanesContainer");
        const subreddits = redditService.getSubreddits();

        if (subreddits.length === 0) {
          lanesContainer.innerHTML = `
                    <div class="lane">
                        <h3>No subreddits added yet</h3>
                        <p>Add your first subreddit to get started!</p>
                    </div>
                `;
          return;
        }

        let lanesHTML = "";

        for (const subreddit of subreddits) {
          try {
            const posts = await redditService.fetchSubredditPosts(subreddit);

            let postsHTML = "";
            posts.forEach((post) => {
              postsHTML += `
                            <div class="post">
                                <a href="${post.url}" target="_blank" class="post-title">${post.title}</a>
                                <div class="post-meta">
                                    ğŸ‘ ${post.score} â€¢ ğŸ’¬ ${post.comments} â€¢ by u/${post.author} â€¢ ${post.created}
                                </div>
                            </div>
                        `;
            });

            lanesHTML += `
                        <div class="lane">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">r/${subreddit}</h3>
                                <button onclick="removeSubreddit('${subreddit}')" style="width: auto; padding: 5px 10px; font-size: 12px;">Remove</button>
                            </div>
                            ${postsHTML}
                        </div>
                    `;
          } catch (error) {
            lanesHTML += `
                        <div class="lane">
                            <h3>r/${subreddit}</h3>
                            <div class="error">Error loading posts: ${error.message}</div>
                            <button onclick="removeSubreddit('${subreddit}')" style="width: auto; margin-top: 10px;">Remove</button>
                        </div>
                    `;
          }
        }

        lanesContainer.innerHTML = lanesHTML;
      }

      function removeSubreddit(subreddit) {
        redditService.removeSubreddit(subreddit);
        refreshLanes();
        showMessage(`ğŸ—‘ï¸ r/${subreddit} removed`, "success");
      }

      // ØªØ³Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡
      window.addEventListener("load", async () => {
        console.log("ğŸš€ Reddit Dashboard Loaded");

        // ØªØ³Øª Ø§ØªØµØ§Ù„ Ø§ÙˆÙ„ÛŒÙ‡
        try {
          await redditService.validateSubreddit("programming");
          console.log("âœ… Reddit API is accessible");
        } catch (error) {
          console.warn("âš ï¸ Reddit API may be blocked:", error.message);
        }
      });

      // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Enter key
      document
        .getElementById("subredditInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            addSubreddit();
          }
        });
    </script>
  </body>
</html>
